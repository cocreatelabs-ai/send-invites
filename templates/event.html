{% extends "base.html" %}

{% block content %}
{% if is_admin %}
<div class="header-links">
    <a href="/admin/event/{{ event_id }}" class="admin-link">Edit Event</a>
    <span class="divider">|</span>
    <a href="/admin/event/{{ event_id }}" class="admin-link">Track RSVPs</a>
    <span class="divider">|</span>
    <a href="/logout" class="logout-link">Logout</a>
</div>
{% endif %}

<div class="event-card">
    {% if header_image %}
    <img src="/static/images/{{ header_image }}" class="header-image" alt="Invitation header">
    {% endif %}
    <h2>{{ title }}</h2>
    {% if description %}
    <p class="description">{{ description }}</p>
    {% endif %}
    {% if rsvp_status == 'yes' %}
    <div class="rsvp-message rsvp-thanks">
        <p>ðŸŽ‰ Thanks for attending! We can't wait to celebrate with you!</p>
    </div>
    {% elif rsvp_status == 'no' %}
    <div class="rsvp-message rsvp-miss">
        <p>ðŸ˜” Oh, sad to miss you! We'll be thinking of you.</p>
    </div>
    {% endif %}
    {% if user_name == 'Guest' and not rsvp_status %}
    <!-- Anonymous RSVP form embedded in event page -->
    <div class="rsvp-form-section">
        <h3>RSVP for this Event</h3>
        <form method="POST" action="/anonymous-rsvp/{{ event_id }}">
            <div class="form-group">
                <label for="guest_name">Your Name:</label>
                <input type="text" id="guest_name" name="guest_name" required>
            </div>
            
            <div class="form-group">
                <label for="guest_phone">Your Phone Number:</label>
                <input type="tel" id="guest_phone" name="guest_phone" required placeholder="(555) 123-4567">
                <small>Use same number to update your RSVP</small>
            </div>
            
            <div class="form-group">
                <label for="guest_email">Your Email (optional):</label>
                <input type="email" id="guest_email" name="guest_email" placeholder="For updates about the event">
            </div>
            
            <div class="rsvp-options">
                <h4>Will you attend?</h4>
                <div class="rsvp-choice">
                    <input type="radio" id="rsvp_yes" name="rsvp" value="yes" required>
                    <label for="rsvp_yes">Yes, I'll be there! ðŸŽ‰</label>
                </div>
                <div class="rsvp-choice">
                    <input type="radio" id="rsvp_no" name="rsvp" value="no" required>
                    <label for="rsvp_no">Sorry, can't make it</label>
                </div>
            </div>
            
            <div class="quantity-section" id="quantity_section" style="display: none;">
                <h4>How many people?</h4>
                <div class="quantity-inputs">
                    <div class="quantity-group">
                        <label for="adults_qty">Adults:</label>
                        <input type="number" id="adults_qty" name="adults_qty" min="1" max="10" value="1">
                    </div>
                    <div class="quantity-group">
                        <label for="kids_qty">Kids:</label>
                        <input type="number" id="kids_qty" name="kids_qty" min="0" max="10" value="0">
                    </div>
                </div>
                
                <div class="dietary-section">
                    <h4>Dietary Restrictions & Allergies</h4>
                    <p class="dietary-help">Please let us know about any dietary restrictions, food allergies, or special accommodations needed.</p>
                    <textarea id="dietary_restrictions" name="dietary_restrictions" 
                              placeholder="e.g., Vegetarian, Gluten-free, Nut allergy, etc." 
                              rows="3"></textarea>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Submit RSVP</button>
        </form>
        
        <script>
        document.querySelectorAll('input[name="rsvp"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const quantitySection = document.getElementById('quantity_section');
                if (this.value === 'yes') {
                    quantitySection.style.display = 'block';
                } else {
                    quantitySection.style.display = 'none';
                }
            });
        });
        </script>
    </div>
    {% endif %}
    
    <script>
    function showQuantityFields() {
        document.getElementById('quantity-fields').style.display = 'block';
        document.getElementById('adults_qty').focus();
    }
    </script>
    <div class="details">
        <div class="detail-item">
            <span class="label">Hosted by</span>
            <span class="value">{{ host }}</span>
        </div>
        <div class="detail-item">
            <span class="label">Date</span>
            <span class="value">
                <a href="#" class="date-link" onclick="toggleCalendarOptions(event)">{{ date_display }}<br>{{ time_display }}</a>
                <div class="calendar-options-dropdown" id="calendar-options" style="display: none;">
                    <a href="{{ calendar_links.google }}" target="_blank">Add to Google Calendar</a>
                    <a href="{{ calendar_links.outlook }}" target="_blank">Add to Outlook</a>
                    <a href="/calendar/{{ event_id }}" download="event_{{ event_id }}.ics">Download for iPhone/Android</a>
                </div>
            </span>
        </div>
        <div class="detail-item">
            <span class="label">Address</span>
            <a href="https://www.google.com/maps?q={{ location | urlencode }}" target="_blank" class="value location-link">{{ location }}</a>
        </div>
    </div>
    <div class="registry">
        <h3>Registry</h3>
        <div class="registry-buttons">
            {% if registry1 %}<a href="{{ registry1 }}" target="_blank" class="btn registry-btn">Babylist</a>{% endif %}
            {% if registry2 %}<a href="{{ registry2 }}" target="_blank" class="btn registry-btn">Amazon</a>{% endif %}
        </div>
    </div>
    <div class="comments-section">
        <h3>Comment Wall</h3>
        <p>We're so excited to see everyone soon! Please leave a note in our guest book below.</p>
        <ul class="comments-list">
            {% if comments %}
                {% for comment, name, timestamp in comments %}
                    <li class="comment-item">
                        <div class="comment-header">
                            <strong class="comment-author">{{ name }}</strong>
                            <span class="comment-time">{{ timestamp }}</span>
                        </div>
                        <div class="comment-text">{{ comment }}</div>
                    </li>
                {% endfor %}
            {% else %}
                <li class="no-comments">No comments yet. Be the first to leave a message!</li>
            {% endif %}
        </ul>
        <form method="POST" action="/event/{{ event_id }}" class="comment-form" onsubmit="return handleCommentSubmit()">
            <input type="hidden" name="action" value="comment">
            <div class="form-group">
                <label for="comment_name_input">Your Name:</label>
                <input type="text" id="comment_name_input" name="comment_name" 
                       value="{% if user_name and user_name != 'Guest' %}{{ user_name }}{% endif %}" 
                       placeholder="Enter your name" required>
            </div>
            <div class="form-group">
                <label for="comment_text">Comment:</label>
                <textarea id="comment_text" name="comment" placeholder="Add a comment" required></textarea>
            </div>
            <button type="submit" class="btn">Post Comment</button>
        </form>
        
        <script>
        // Auto-populate name field when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const nameField = document.getElementById('comment_name_input');
            
            // If name field is empty, try to get it from various sources
            if (!nameField.value.trim()) {
                // First, try to get from RSVP form if available and filled
                const rsvpNameField = document.getElementById('guest_name');
                if (rsvpNameField && rsvpNameField.value.trim()) {
                    nameField.value = rsvpNameField.value.trim();
                }
                // Note: Session name is already populated via server-side template
            }
        });
        
        function handleCommentSubmit() {
            const nameField = document.getElementById('comment_name_input');
            let name = nameField.value.trim();
            
            // If still no name, require user to enter one
            if (!name) {
                alert('Please enter your name for the comment.');
                nameField.focus();
                return false;
            }
            
            return true; // Allow form submission
        }
        
        function toggleCalendarOptions(event) {
            event.preventDefault();
            const dropdown = document.getElementById('calendar-options');
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('calendar-options');
            const dateLink = event.target.closest('.date-link');
            if (!dateLink && dropdown) {
                dropdown.style.display = 'none';
            }
        });
        </script>
    </div>
</div>
{% endblock %}