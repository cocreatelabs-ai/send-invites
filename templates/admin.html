{% extends "base.html" %}

{% block content %}
<div class="logout-link">
    <a href="/logout">Logout</a>
</div>
<div class="admin-panel">
    <h2>Customize Your Event</h2>
    <form method="POST" action="/admin/event/{{ event_id }}">
        <div class="form-group">
            <label for="title">Event Title:</label>
            <input type="text" id="title" name="title" value="{{ event.title }}" required>
        </div>
        
        <div class="form-group">
            <label for="description">Description:</label>
            <textarea id="description" name="description" rows="3">{{ event.description }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="host">Hosted by:</label>
            <input type="text" id="host" name="host" value="{{ event.host }}" required>
        </div>
        
        <div class="form-group">
            <label for="datetime">Date & Time:</label>
            <input type="datetime-local" id="datetime" name="datetime" value="{{ event.datetime }}" required>
        </div>
        
        <div class="form-group">
            <label for="location">Location:</label>
            <textarea id="location" name="location" rows="2">{{ event.location }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="registry1">Registry 1 (Babylist URL):</label>
            <input type="url" id="registry1" name="registry1" value="{{ event.registry1 }}">
        </div>
        
        <div class="form-group">
            <label for="registry2">Registry 2 (Amazon URL):</label>
            <input type="url" id="registry2" name="registry2" value="{{ event.registry2 }}">
        </div>
        
        <div class="form-group">
            <label for="card_theme">Card Theme:</label>
            <select id="card_theme" name="card_theme">
                <option value="ocean"{% if event.card_theme == 'ocean' %} selected{% endif %}>Ocean Theme</option>
                <option value="garden"{% if event.card_theme == 'garden' %} selected{% endif %}>Garden Theme</option>
                <option value="classic"{% if event.card_theme == 'classic' %} selected{% endif %}>Classic Theme</option>
            </select>
        </div>
        
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <a href="/event/{{ event_id }}" class="btn btn-secondary">Preview Event</a>
    </form>
    
    <div class="custom-links-section">
        <h3>Generate Custom Invite Links</h3>
        <p>Create personalized invite links with pre-filled guest information:</p>
        
        <div class="link-generator">
            <div class="form-group">
                <label for="link_name">Guest Name:</label>
                <input type="text" id="link_name" placeholder="John Smith">
            </div>
            <div class="form-group">
                <label for="link_phone">Guest Phone:</label>
                <input type="tel" id="link_phone" placeholder="(555) 123-4567">
            </div>
            <div class="form-group">
                <label for="link_email">Guest Email (optional):</label>
                <input type="email" id="link_email" placeholder="john@example.com">
            </div>
            <button type="button" onclick="generateCustomLink()" class="btn btn-secondary">Generate Link</button>
            
            <div class="generated-link" id="generated-link" style="display: none;">
                <h4>Custom Invite Link:</h4>
                <input type="text" id="custom-link-input" readonly style="width: 100%; margin: 10px 0;">
                <button type="button" onclick="copyLink()" class="btn btn-small">Copy Link</button>
            </div>
        </div>
        
        <script>
        function generateCustomLink() {
            const name = document.getElementById('link_name').value;
            const phone = document.getElementById('link_phone').value;
            const email = document.getElementById('link_email').value;
            
            if (!name || !phone) {
                alert('Please enter at least a name and phone number');
                return;
            }
            
            const baseUrl = window.location.origin + '/anonymous-rsvp/{{ event_id }}';
            const params = new URLSearchParams();
            params.append('name', name);
            params.append('phone', phone);
            if (email) params.append('email', email);
            
            const customLink = baseUrl + '?' + params.toString();
            document.getElementById('custom-link-input').value = customLink;
            document.getElementById('generated-link').style.display = 'block';
        }
        
        function copyLink() {
            const linkInput = document.getElementById('custom-link-input');
            linkInput.select();
            document.execCommand('copy');
            
            const copyButton = event.target;
            const originalText = copyButton.textContent;
            copyButton.textContent = 'Copied!';
            setTimeout(() => {
                copyButton.textContent = originalText;
            }, 2000);
        }
        </script>
    </div>
    
    <script>
    // Function to copy invite links for guests
    function copyInviteLink(name, phone, email) {
        const baseUrl = window.location.origin + '/anonymous-rsvp/{{ event_id }}';
        const params = new URLSearchParams();
        params.append('name', name);
        params.append('phone', phone);
        if (email) params.append('email', email);
        
        const inviteLink = baseUrl + '?' + params.toString();
        
        // Copy to clipboard
        navigator.clipboard.writeText(inviteLink).then(function() {
            showCopyFeedback(event.target, '‚úÖ Copied!');
        }).catch(function() {
            // Fallback for older browsers
            fallbackCopyTextToClipboard(inviteLink);
            showCopyFeedback(event.target, '‚úÖ Copied!');
        });
    }
    
    // Function to create text message
    function createTextMessage(name, phone, email) {
        const baseUrl = window.location.origin + '/anonymous-rsvp/{{ event_id }}';
        const params = new URLSearchParams();
        params.append('name', name);
        params.append('phone', phone);
        if (email) params.append('email', email);
        
        const inviteLink = baseUrl + '?' + params.toString();
        const firstName = name.split(',')[0].trim().replace(/"/g, '');
        const message = `Hi ${firstName}! You're invited to our baby shower. Please RSVP here: ${inviteLink}`;
        
        // Copy message to clipboard
        navigator.clipboard.writeText(message).then(function() {
            showCopyFeedback(event.target, '‚úÖ Message Copied!');
        }).catch(function() {
            fallbackCopyTextToClipboard(message);
            showCopyFeedback(event.target, '‚úÖ Message Copied!');
        });
    }
    
    // Helper function to show copy feedback
    function showCopyFeedback(button, message) {
        const originalText = button.textContent;
        const originalBg = button.style.backgroundColor;
        button.textContent = message;
        button.style.backgroundColor = '#28a745';
        
        setTimeout(() => {
            button.textContent = originalText;
            button.style.backgroundColor = originalBg;
        }, 2000);
    }
    
    // Fallback copy function for older browsers
    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
    }
    
    // Filter guests by RSVP status
    function filterGuests() {
        const filterValue = document.getElementById('statusFilter').value;
        const guestCards = document.querySelectorAll('.guest-card');
        let visibleCount = 0;
        
        guestCards.forEach(card => {
            const cardStatus = card.getAttribute('data-status');
            if (filterValue === 'all' || cardStatus === filterValue) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });
        
        updateNoResultsDisplay(visibleCount);
    }
    
    // Search guests by name, email, or phone
    function searchGuests() {
        const searchValue = document.getElementById('searchGuests').value.toLowerCase();
        const guestCards = document.querySelectorAll('.guest-card');
        let visibleCount = 0;
        
        guestCards.forEach(card => {
            const searchData = card.getAttribute('data-search');
            if (searchData.includes(searchValue)) {
                // Also check filter
                const filterValue = document.getElementById('statusFilter').value;
                const cardStatus = card.getAttribute('data-status');
                if (filterValue === 'all' || cardStatus === filterValue) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            } else {
                card.style.display = 'none';
            }
        });
        
        updateNoResultsDisplay(visibleCount);
    }
    
    // Update no results display
    function updateNoResultsDisplay(visibleCount) {
        const noResults = document.getElementById('noResults');
        if (visibleCount === 0) {
            noResults.style.display = 'block';
        } else {
            noResults.style.display = 'none';
        }
    }
    </script>
    
    <div class="csv-import-section">
        <h3>Bulk Import Guest List</h3>
        <p>Upload a CSV file with guest information to generate invite links in bulk:</p>
        
        <div class="csv-import-info">
            <h4>CSV Format Requirements:</h4>
            <ul>
                <li><strong>Required columns:</strong> Name, Phone</li>
                <li><strong>Optional columns:</strong> Email</li>
                <li><strong>Example header row:</strong> Name,Phone,Email</li>
                <li><strong>Example data row:</strong> "John & Jane Smith",+15551234567,john@example.com</li>
            </ul>
        </div>
        
        <form method="POST" action="/admin/import-csv/{{ event_id }}" enctype="multipart/form-data" class="csv-import-form">
            <div class="form-group">
                <label for="csv_file">Select CSV File:</label>
                <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
            </div>
            <button type="submit" class="btn btn-primary">Import Guests & Generate Links</button>
        </form>
        
        {% if import_results %}
        <div class="import-results">
            <h4>Import Results:</h4>
            {% if import_results.success %}
                <div class="success-message">
                    ‚úÖ Successfully imported {{ import_results.imported_count }} guests!
                    <ul>
                        <li>New invites created: {{ import_results.new_count }}</li>
                        <li>Existing invites updated: {{ import_results.updated_count }}</li>
                    </ul>
                </div>
            {% endif %}
            
            {% if import_results.errors %}
                <div class="error-message">
                    ‚ùå Errors encountered:
                    <ul>
                        {% for error in import_results.errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    
    <div class="rsvp-tracking">
        <h3>RSVP Tracking</h3>
        <div class="rsvp-summary">
            <div class="rsvp-stat">
                <span class="stat-number">{{ rsvp_stats.attending }}</span>
                <span class="stat-label">Attending</span>
            </div>
            <div class="rsvp-stat">
                <span class="stat-number">{{ rsvp_stats.not_attending }}</span>
                <span class="stat-label">Not Attending</span>
            </div>
            <div class="rsvp-stat">
                <span class="stat-number">{{ rsvp_stats.no_response }}</span>
                <span class="stat-label">No Response</span>
            </div>
        </div>
        
        <div class="quantity-summary">
            <div class="quantity-stat">
                <span class="stat-number">{{ rsvp_stats.total_adults }}</span>
                <span class="stat-label">Total Adults</span>
            </div>
            <div class="quantity-stat">
                <span class="stat-number">{{ rsvp_stats.total_kids }}</span>
                <span class="stat-label">Total Kids</span>
            </div>
            <div class="quantity-stat">
                <span class="stat-number">{{ rsvp_stats.total_adults + rsvp_stats.total_kids }}</span>
                <span class="stat-label">Total Guests</span>
            </div>
        </div>
        
        <div class="guest-list">
            <div class="guest-list-header">
                <h4>Guest List ({{ guests|length }} guests)</h4>
                <div class="guest-list-controls">
                    <div class="filter-controls">
                        <label for="statusFilter">Filter by Status:</label>
                        <select id="statusFilter" onchange="filterGuests()">
                            <option value="all">All Guests</option>
                            <option value="yes">Attending</option>
                            <option value="no">Not Attending</option>
                            <option value="pending">No Response</option>
                        </select>
                    </div>
                    <div class="search-controls">
                        <label for="searchGuests">Search:</label>
                        <input type="text" id="searchGuests" placeholder="Search by name, email, or phone" oninput="searchGuests()">
                    </div>
                </div>
            </div>
            
            <div class="guest-cards-container">
                {% for guest in guests %}
                <div class="guest-card" data-status="{{ guest.rsvp or 'pending' }}" data-search="{{ (guest.name + ' ' + (guest.email or '') + ' ' + (guest.phone or ''))|lower }}">
                    <div class="guest-card-header">
                        <div class="guest-info">
                            <h5 class="guest-name">
                                {{ guest.name }}
                                {% if guest.is_anonymous %}
                                    <span class="anonymous-badge">Anonymous Invite</span>
                                {% else %}
                                    <span class="registered-badge">Registered User</span>
                                {% endif %}
                            </h5>
                            <div class="guest-contact">
                                {% if guest.email %}
                                    <div class="contact-item">
                                        <span class="contact-icon">üìß</span>
                                        <span class="contact-value">{{ guest.email }}</span>
                                    </div>
                                {% endif %}
                                {% if guest.phone %}
                                    <div class="contact-item">
                                        <span class="contact-icon">üì±</span>
                                        <span class="contact-value">{{ guest.phone }}</span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="guest-status">
                            <div class="rsvp-status-badge rsvp-{{ guest.rsvp or 'pending' }}">
                                {% if guest.rsvp == 'yes' %}
                                    <span class="status-icon">‚úÖ</span>
                                    <span class="status-text">Attending</span>
                                {% elif guest.rsvp == 'no' %}
                                    <span class="status-icon">‚ùå</span>
                                    <span class="status-text">Not Attending</span>
                                {% else %}
                                    <span class="status-icon">‚è≥</span>
                                    <span class="status-text">No Response</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    {% if guest.rsvp == 'yes' %}
                    <div class="guest-details">
                        <div class="attendance-info">
                            <div class="attendance-item">
                                <span class="attendance-label">Adults:</span>
                                <span class="attendance-value">{{ guest.adults_qty or 1 }}</span>
                            </div>
                            <div class="attendance-item">
                                <span class="attendance-label">Kids:</span>
                                <span class="attendance-value">{{ guest.kids_qty or 0 }}</span>
                            </div>
                            <div class="attendance-item total">
                                <span class="attendance-label">Total:</span>
                                <span class="attendance-value">{{ (guest.adults_qty or 1) + (guest.kids_qty or 0) }}</span>
                            </div>
                        </div>
                        
                        {% if guest.dietary_restrictions %}
                        <div class="dietary-info">
                            <span class="dietary-label">üçΩÔ∏è Dietary Restrictions:</span>
                            <span class="dietary-text">{{ guest.dietary_restrictions }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <div class="guest-actions">
                        {% if guest.phone and guest.is_anonymous %}
                            <button type="button" 
                                    class="btn btn-small copy-link-btn" 
                                    onclick="copyInviteLink('{{ guest.name }}', '{{ guest.phone }}', '{{ guest.email or '' }}')"
                                    title="Copy invite link">
                                üìã Copy Invite Link
                            </button>
                        {% endif %}
                        
                        {% if guest.phone %}
                            <button type="button" 
                                    class="btn btn-small message-btn" 
                                    onclick="createTextMessage('{{ guest.name }}', '{{ guest.phone }}', '{{ guest.email or '' }}')"
                                    title="Create text message">
                                üí¨ Text Message
                            </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="no-results" id="noResults" style="display: none;">
                <p>No guests match your search criteria.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}